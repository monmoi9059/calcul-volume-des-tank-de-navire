<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculateur de Volume (Bidirectionnel)</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;margin:0;background:#0d1b2a;color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;max-width:900px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    h1,h2{margin:0 0 12px;font-size:22px;border-bottom:1px solid #334155;padding-bottom:8px;}
    h2{font-size:18px;margin-top:20px;}
    label{display:block;margin-bottom:6px;font-size:14px}
    select,input,button{width:100%;padding:10px 12px;margin-bottom:12px;border-radius:8px;border:none;font-size:14px;box-sizing:border-box;}
    input,select{background:#1b263b;color:#fff}
    input#tankHeight {background:#374151;}
    button{background:#06b6d4;color:#042;font-weight:600;cursor:pointer;transition:background-color 0.2s ease;}
    button:hover{background:#164e63;color:#e0f2f1;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .col{flex:1;min-width:150px;}
    .output{background:#1b263b;padding:12px;border-radius:10px;margin-top:10px;overflow-x:auto;}
    .note{font-size:13px;color:#bcd;background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:16px;}
    
    .mode-selector { background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; margin-bottom:16px; display:flex; justify-content:center; gap:20px; }
    .mode-selector label { cursor:pointer; display:flex; align-items:center; gap:8px; }

    #tankInputsContainer {display:grid;grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));gap:10px;margin-top:10px;}
    .tank-input-group label {font-size:12px;}
    .tank-input-group input {padding:8px;font-size:13px;text-align:center;}

    #stowagePlanViz {display:grid;grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));gap:12px;padding:10px;min-height:150px;}
    .stowage-tank {background:#334155;border-radius:4px;height:120px;position:relative;display:flex;flex-direction:column-reverse;box-shadow:inset 0 0 10px rgba(0,0,0,0.5);}
    .stowage-liquid {background:#0ea5e9;border-radius:inherit;width:100%;transition:height 0.5s ease-out;}
    .stowage-label {position:absolute;top:5px;left:0;right:0;text-align:center;font-size:11px;color:#fff;font-weight:bold;text-shadow:1px 1px 2px #000;}
    .stowage-info {position:absolute;bottom:5px;left:0;right:0;text-align:center;font-size:10px;color:#fff;}

    table {width:100%;border-collapse:collapse;margin-top:10px;}
    th, td {padding:8px 12px;text-align:left;border-bottom:1px solid #334155;}
    th {background:#1e293b;font-size:14px;}
    td {font-size:13px;}
    tfoot tr {font-weight:bold;}
    tfoot td {background-color:rgba(6,182,212,0.1);}
  </style>
</head>
<body>
  <div class="card">
    <h1>Calculateur de Volume (Bidirectionnel)</h1>
    <p class="note"><strong>Mode d'emploi :</strong><br>1. Estimez la capacité du navire à partir du TPL/DWT.<br>2. Choisissez un mode de calcul: entrez une hauteur pour obtenir un volume, ou entrez un volume pour obtenir une hauteur.<br>3. Remplissez les champs pour chaque réservoir et cliquez sur "Calculer".</p>

    <h2>Étape 1: Estimer la Capacité du Navire</h2>
    <div class="row">
        <div class="col"><label for="product">Produit transporté</label><select id="product"><option value="diesel">Diesel (densité ≈ 0.84 t/m³)</option><option value="essence">Essence (densité ≈ 0.74 t/m³)</option></select></div>
        <div class="col"><label for="tplInput">Entrer TPL/DWT du navire</label><input id="tplInput" type="number" placeholder="ex: 15000" /></div>
        <div class="col"><label>&nbsp;</label><button id="estimateBtn">Estimer Capacité & Hauteur</button></div>
    </div>
    
    <h2>Étape 2: Configurer le Calcul</h2>
    <div class="row">
        <div class="col"><label for="tankHeight">Hauteur des réservoirs (m) [Auto]</label><input id="tankHeight" type="number" step="0.1"></div>
        <div class="col"><label for="numberOfTanks">Nombre de réservoirs</label><input id="numberOfTanks" type="number" value="14" min="1" step="1"></div>
        <div class="col"><label for="tankCoefficient">Coefficient de Forme</label><input id="tankCoefficient" type="number" value="0.98" min="0.8" max="1.0" step="0.01"></div>
    </div>
    
    <div class="mode-selector">
        <label><input type="radio" id="modeHeight" name="calcMode" value="height" checked> Calculer le Volume par la Hauteur</label>
        <label><input type="radio" id="modeVolume" name="calcMode" value="volume"> Calculer la Hauteur par le Volume</label>
    </div>

    <div id="tankInputsContainer"></div>
    <button id="calc" style="margin-top:16px; background-color: #16a34a;">Calculer et Mettre à Jour le Plan</button>

    <h2>Étape 3: Résultats et Plan de Chargement</h2>
    <div class="output"><h3>Plan de Chargement Visuel</h3><div id="stowagePlanViz"><p>Le plan apparaîtra ici.</p></div></div>
    <div class="output"><h3>Tableau des Quantités</h3><div id="resultArea"><p>Les résultats détaillés apparaîtront ici.</p></div></div>
  </div>

<script>
let estimatedTotalGeometricVolume = 0;
const DENSITIES = { diesel: 0.84, essence: 0.74 };
const VESSEL_DATA_BY_DWT = {
    coastal:   { dwt: [5000, 19999],   height: 10 }, handysize: { dwt: [20000, 34999],  height: 14 },
    handymax:  { dwt: [35000, 59999],  height: 16 }, panamax:   { dwt: [60000, 79999],  height: 20 },
    aframax:   { dwt: [80000, 119999], height: 22 }, suezmax:   { dwt: [120000, 199999], height: 25 },
    vlcc:      { dwt: [200000, 319999], height: 28 }, ulcc:      { dwt: [320000, 550000], height: 35 }
};

const estimateBtn = document.getElementById('estimateBtn'), calcBtn = document.getElementById('calc'), tplInput = document.getElementById('tplInput'), productSel = document.getElementById('product'), numberOfTanksInput = document.getElementById('numberOfTanks'), tankHeightInput = document.getElementById('tankHeight'), tankCoefficientInput = document.getElementById('tankCoefficient'), tankInputsContainer = document.getElementById('tankInputsContainer'), resultArea = document.getElementById('resultArea'), stowagePlanViz = document.getElementById('stowagePlanViz');
const modeRadios = document.querySelectorAll('input[name="calcMode"]');

function round(n, d = 2) { return Math.round(n * Math.pow(10, d)) / Math.pow(10, d); }

function getTankNames(nTanks) {
    const names = [], portTanks = Math.ceil(nTanks / 2), starboardTanks = Math.floor(nTanks / 2);
    for (let i = 1; i <= portTanks; i++) names.push(`${i}P`);
    for (let i = 1; i <= starboardTanks; i++) names.push(`${i}T`);
    return names;
}

function generateTankInputs() {
    tankInputsContainer.innerHTML = '';
    const nTanks = parseInt(numberOfTanksInput.value) || 1;
    const tankNames = getTankNames(nTanks);
    const isHeightMode = document.getElementById('modeHeight').checked;
    const labelUnit = isHeightMode ? '(m)' : '(m³)';
    const defaultVal = isHeightMode ? 1 : 100;
    const stepVal = isHeightMode ? 0.1 : 10;

    tankNames.forEach((name, index) => {
        const group = document.createElement('div');
        group.className = 'tank-input-group';
        group.innerHTML = `<label for="tank_input_${index}">Réservoir ${name} ${labelUnit}</label><input type="number" id="tank_input_${index}" class="tank-fill-input" value="${defaultVal}" step="${stepVal}" min="0">`;
        tankInputsContainer.appendChild(group);
    });
}

estimateBtn.addEventListener('click', () => {
    const tplVal = parseFloat(tplInput.value);
    if (isNaN(tplVal) || tplVal <= 0) return alert('Veuillez entrer une valeur de TPL/DWT positive.');
    
    let estimatedHeight = 14; 
    for (const key in VESSEL_DATA_BY_DWT) { const data = VESSEL_DATA_BY_DWT[key]; if (tplVal >= data.dwt[0] && tplVal <= data.dwt[1]) { estimatedHeight = data.height; break; }}
    tankHeightInput.value = estimatedHeight;

    const density = DENSITIES[productSel.value], cargoWeight = tplVal * 0.95, totalUsableVolume = cargoWeight / density;
    estimatedTotalGeometricVolume = totalUsableVolume / 0.98;
    
    alert(`Capacité estimée: ${round(totalUsableVolume)} m³ (utile).\nLa hauteur des réservoirs a été ajustée à ${estimatedHeight} m.`);
    resultArea.innerHTML = `<p>Entrez les valeurs de remplissage et cliquez sur Calculer.</p>`;
    stowagePlanViz.innerHTML = `<p>En attente du calcul...</p>`;
});

calcBtn.addEventListener('click', () => {
    if (estimatedTotalGeometricVolume <= 0) return alert('Veuillez d\'abord estimer la capacité totale.');

    const nTanks = parseInt(numberOfTanksInput.value) || 1, H = parseFloat(tankHeightInput.value), tankCoeff = parseFloat(tankCoefficientInput.value), density = DENSITIES[productSel.value];
    const tankNames = getTankNames(nTanks), tankFillInputs = document.querySelectorAll('.tank-fill-input'), isHeightMode = document.getElementById('modeHeight').checked;
    if (isNaN(H) || H <= 0 || isNaN(tankCoeff)) return alert('Hauteur totale et coefficient invalides.');
    
    let results = [], geometricVolumePerTank = estimatedTotalGeometricVolume / nTanks, surfaceAreaPerTank = geometricVolumePerTank / H;

    for (let i = 0; i < tankFillInputs.length; i++) {
        const inputValue = parseFloat(tankFillInputs[i].value);
        let filledVolume = 0, calculatedHeight = 0;

        if (isHeightMode) {
            calculatedHeight = inputValue;
            if (calculatedHeight > H) return alert(`La hauteur pour le réservoir ${tankNames[i]} ne peut dépasser ${H} m.`);
            filledVolume = surfaceAreaPerTank * calculatedHeight * tankCoeff;
        } else {
            filledVolume = inputValue;
            const maxVol = surfaceAreaPerTank * H * tankCoeff;
            if(filledVolume > maxVol) {
                alert(`Le volume pour le réservoir ${tankNames[i]} dépasse sa capacité max (${round(maxVol)} m³). Il sera considéré comme plein.`);
                filledVolume = maxVol;
            }
            calculatedHeight = filledVolume / (surfaceAreaPerTank * tankCoeff);
        }
        
        results.push({
            tankName: tankNames[i], volume: filledVolume,
            height: calculatedHeight, mass: filledVolume * density,
            fillPct: (calculatedHeight / H) * 100
        });
    }
    updateResultsTable(results, isHeightMode);
    updateStowageViz(results);
});

function updateResultsTable(results, isHeightMode) {
    let totalVolume = 0, totalMass = 0;
    const header_H_or_V = isHeightMode ? 'Volume (m³)' : 'Hauteur (m)';
    let tableHTML = `<table><thead><tr><th>Réservoir</th><th>${header_H_or_V}</th><th>% Rempli</th><th>Poids (tonnes)</th></tr></thead><tbody>`;

    results.forEach(r => {
        totalVolume += r.volume; totalMass += r.mass;
        const resultValue = isHeightMode ? round(r.volume) : `${round(r.height)} / ${tankHeightInput.value}`;
        tableHTML += `<tr><td>${r.tankName}</td><td>${resultValue}</td><td>${round(r.fillPct, 1)}%</td><td>${round(r.mass)}</td></tr>`;
    });
    
    tableHTML += `</tbody><tfoot><tr><td><strong>TOTAL</strong></td><td><strong>${round(totalVolume)}</strong></td><td>-</td><td><strong>${round(totalMass)}</strong></td></tr></tfoot></table>`;
    resultArea.innerHTML = tableHTML;
}

function updateStowageViz(results) {
    stowagePlanViz.innerHTML = '';
    results.forEach(r => {
        const tankDiv = document.createElement('div');
        tankDiv.className = 'stowage-tank';
        tankDiv.innerHTML = `<div class="stowage-liquid" style="height:${r.fillPct}%"></div><span class="stowage-label">${r.tankName}</span><span class="stowage-info">${round(r.volume)} m³</span>`;
        stowagePlanViz.appendChild(tankDiv);
    });
}

// --- INITIALIZE ---
numberOfTanksInput.addEventListener('input', generateTankInputs);
modeRadios.forEach(radio => radio.addEventListener('change', generateTankInputs));
document.addEventListener('DOMContentLoaded', () => {
    generateTankInputs();
    tplInput.value = 15000;
    estimateBtn.click();
});
</script>
</body>
</html>
